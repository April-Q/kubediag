# Storage

KubeDiag supports storing the processing results of processors in minio.

## Background

Users can store the diagnosis result file in minio for later review by configuring the operation storage mode.

## Design

Storage

## Implementation

Enabling minio storage requires configuring the parameters `minio-endpoint`, `minio-access-key-id`, `minio-secret-access-key`, and `minio-ssl` in the agent.

* `minio-endpoint`: S3 compatible object storage endpoint.
* `minio-access-key-id`: Access key for the object storage.
* `minio-secret-access-key`: Secret key for the object storage.
* `minio-ssl`: If 'true' API requests will be secure (HTTPS), and insecure (HTTP) otherwise.

For each operation diagnosis, if the output result is a file and you want to store it in minio, the file path should be returned in the return body. Then the agent will obtain the file according to the path for storage.

## API

To achieve our design purposes, we extend the `Operation` API with `Storage`.

```go
// OperationSpec defines the desired state of Operation.
type OperationSpec struct {
  // Processor describes how to register a operation processor into kubediag.
  Processor Processor `json:"processor"`
  // Dependences is the list of all depended operations required to be precedently executed.
  // +optional
  Dependences []string `json:"dependences,omitempty"`
  // Storage represents the type of storage for operation results.
  // Operation output will not be managed by any storage driver if nil.
  // +optional
  Storage *Storage `json:"storage,omitempty"`
}

// Storage represents the type of storage for operation results.
type Storage struct {
  // Provisioner specify which storage to save object.
  // Only support minio now.
  Provisioner string `json:"provisioner"`
  // Key specify the scrap key to get file.
  OperationResultFilePathKey string `json:"operationResultFilePathKey"`
}
```

The storage is designed for users to define how should KubeDiag store their data. It contains the following fields:

* `spec.storage.provisioner`: Provisioner should be declared as `minio` in operation.
* `spec.storage.operationResultFilePathKey`: operationResultFilePathKey indicates the file path key that needs to be stored.

## Example

Here is example to store the file generated by go profiler operation in minio.

```yaml
apiVersion: diagnosis.kubediag.org/v1
kind: Operation
metadata:
  name: go-profiler
spec:
  processor:
    path: /processor/goProfiler
    scheme: http
    timeoutSeconds: 60
  storage: 
    provisioner: minio
    operationResultFilePathKey: diagnoser.runtime.go_profiler.result.path
```

After diagnosis, the result generated by go profiler processor contains keys `diagnoser.runtime.go_profiler.result.path`. The value of key `diagnoser.runtime.go_profiler.result.path` corresponds to the generated file path, which will be obtained by agent and stored as file in the form of a key-value pair, with `<bucket_name>/<diagnosis_namespace>.<diagnosis_name>.<node_name>.<pod_namespace>.<pod_name>.<container_name>.<timestamp>.<file_name>` as key and file as value. Undefined values in key are represented by `0`.

```yaml
apiVersion: diagnosis.kubediag.org/v1
kind: Diagnosis
metadata:
  annotations:
    storage.operation.go_profiler.stored.file: go-profiler/default.go-profiler.my-node.0.0.0.20210728084437.default.go-profiler.heap.prof
  # ......
  name: go-profiler
  namespace: default
spec:
  nodeName: my-node
  operationSet: go-profiler
  parameters:
    param.diagnoser.runtime.go_profiler.expiration_seconds: "7200"
    param.diagnoser.runtime.go_profiler.source: https://10.0.2.15:6443
    param.diagnoser.runtime.go_profiler.tls.secret_reference.name: apiserver-profiler-sa-token-wqnr2
    param.diagnoser.runtime.go_profiler.tls.secret_reference.namespace: kubediag
    param.diagnoser.runtime.go_profiler.type: Heap
status:
  phase: Succeeded
  operationResults:
    diagnoser.runtime.go_profiler.result.path: /var/lib/kubediag/profilers/go/pprof/20210728084437/default.go-profiler.heap.prof
  # ......
```

After successful storage, the annotation of this diagnosis will record the stored file in minio is `go-profiler/default.go-profiler.my-node.0.0.0.20210728084437.default.go-profiler.heap.prof`. If the stored procedure fails, the value corresponding to this annotation is `<none>`.
